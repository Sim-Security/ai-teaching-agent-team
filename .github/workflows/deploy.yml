# =============================================================================
# GitHub Actions: Build, Test & Deploy to Cloud Run
# =============================================================================
#
# Triggers: Push to main branch
# Deploys: Google Cloud Run (us-central1)
#
# Required GitHub Secrets:
#   - GCP_PROJECT_ID: Your GCP project ID
#   - GCP_SA_KEY: Service account JSON key (base64 encoded)
#   - GCP_REGION: Deployment region (default: us-central1)
#
# Required GCP IAM Roles for Service Account:
#   - Cloud Run Admin
#   - Storage Admin
#   - Artifact Registry Writer
#   - Service Account User
# =============================================================================

name: Build, Test & Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  SERVICE_NAME: ai-teaching-agent-team
  REGION: ${{ secrets.GCP_REGION || 'us-central1' }}
  ARTIFACT_REGISTRY: docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/cloud-run-images

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: Lint & Test
  # ---------------------------------------------------------------------------
  test:
    name: Lint & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov ruff

      - name: Lint with Ruff
        run: |
          ruff check --output-format=github .
        continue-on-error: true

      - name: Run tests
        run: |
          # Run pytest if tests exist, otherwise skip
          if [ -d "tests" ] || find . -name "test_*.py" -o -name "*_test.py" | grep -q .; then
            pytest --cov=src --cov-report=xml -v
          else
            echo "No tests found, skipping..."
          fi
        continue-on-error: true

  # ---------------------------------------------------------------------------
  # Job 2: Build & Push Docker Image
  # ---------------------------------------------------------------------------
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION || 'us-central1' }}-docker.pkg.dev --quiet

      - name: Create Artifact Registry repository (if not exists)
        run: |
          gcloud artifacts repositories describe cloud-run-images \
            --location=${{ env.REGION }} 2>/dev/null || \
          gcloud artifacts repositories create cloud-run-images \
            --repository-format=docker \
            --location=${{ env.REGION }} \
            --description="Cloud Run container images"
        continue-on-error: true

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ARTIFACT_REGISTRY }}/${{ env.SERVICE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.ARTIFACT_REGISTRY }}/${{ env.SERVICE_NAME }}:latest
          cache-to: type=inline

  # ---------------------------------------------------------------------------
  # Job 3: Deploy to Cloud Run
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{ env.ARTIFACT_REGISTRY }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
          flags: |
            --port=8080
            --memory=2Gi
            --cpu=2
            --timeout=300
            --concurrency=80
            --min-instances=0
            --max-instances=10
            --allow-unauthenticated
            --set-env-vars=STREAMLIT_SERVER_PORT=8080,STREAMLIT_SERVER_ADDRESS=0.0.0.0

      - name: Show deployment URL
        run: |
          echo "## Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Service URL: ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployed at: $(date -u)" >> $GITHUB_STEP_SUMMARY

      - name: Health check
        run: |
          sleep 10
          curl -f "${{ steps.deploy.outputs.url }}/_stcore/health" || echo "Health check endpoint not responding (app may still be starting)"
        continue-on-error: true
